"use strict";function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_unsupportedIterableToArray(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}function _iterableToArrayLimit(a,b){var c=null==a?null:"undefined"!=typeof Symbol&&a[Symbol.iterator]||a["@@iterator"];if(null!=c){var d,e,f,g,h=[],i=!0,j=!1;try{if(f=(c=c.call(a)).next,0===b){if(Object(c)!==c)return;i=!1}else for(;!(i=(d=f.call(c)).done)&&(h.push(d.value),h.length!==b);i=!0);}catch(a){j=!0,e=a}finally{try{if(!i&&null!=c["return"]&&(g=c["return"](),Object(g)!==g))return}finally{if(j)throw e}}return h}}function _arrayWithHoles(a){if(Array.isArray(a))return a}var chanTop={vstep:50,init:function init(a,b){this.$el=a.addClass("chantop"),this.$el.empty(),this.chans=b,this.load()},makeCSS:function makeCSS(a){var b="",c=this.vstep;_.range(a).forEach(function(a){var d="";has3d?["","-webkit-"].forEach(function(b){d+="".concat(b,"transform: translate3d(0, ").concat(c*a,"px, 0);\n")}):d+="top: ".concat(c*a+10,"px;"),b+="#co-".concat(a," {\n").concat(d,"}\n")}),b+=".chantop { height: ".concat(a*c,"px }"),injector.inject("chantop-positions",b)},load:function load(){var a=this;this.makeCSS(this.chans.length),this.chans.forEach(function(b){b.$el=$(a.buildChan(b)),b.$el.find(".adder-remover").click(function(){installer.toggle(b.id)}),a.$el.append(b.$el)}),API.getRates(),this.upd=setInterval(function(){new Date().getTime()-a.lastUpdated>a.interval/2&&!$("#chantop").is(":hover")&&"hidden"!==$("#chantop").css("visibility")&&API.getRates()},this.interval)},stahp:function stahp(){clearInterval(this.upd)},updateRatings:function updateRatings(a){this.lastUpdated=new Date().getTime();var b=_.map(this.chans,"id"),c=_.map(a,"id");return c.length!==b.length||_.difference(b,c).length?void document.location.reload():void(this.chans.forEach(function(b){b.rating=+_.find(a,{id:b.id}).rating,b.$el.find(".chan-rating").text(b.rating)}),this.arrange())},interval:5e3,buildChan:function buildChan(a){var b=installer.isInstalled(a.id),c=b?"\xD7":"+",d=b?"\u0423\u0434\u0430\u043B\u0438\u0442\u044C":"\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C",e=_.escape(a.name),f=a.wiki&&a.wiki.match(/https?:\/\//)?a.wiki:conf.wiki+(a.wiki||e);return"<div class=\"ct-chan\"><img src=\"/chans/balls/".concat(a.section,"/").concat(a.id,".png").concat(a.ballv?"?v=".concat(a.ballv):"","\" alt=\"").concat(e,"\" class=\"chan-avatar\"><div class=\"catc-addremove adder-remover\" title=\"").concat(d,"\">").concat(c,"</div><a href=\"").concat(_.escape(a.url),"\" target=\"_blank\" class=\"chan-name\"><span>").concat(e,"</span></a><div class=\"chan-rating\">").concat(a.rating,"</div><div class=\"chan-rating-delta\"></div><a target=\"_blank\" href=\"").concat(f,"\" class=\"catc-info\" title=\"\u0418\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u044F\">i</a></div>")},arrange:function arrange(){var a=this;_.sortByOrder(chanTop.chans,["rating","name"],["desc","asc"]).forEach(function(b,c){if(b.$el.attr("id","co-".concat(c)),a.arranged){var d=" hovering";if(c<b.order?d+=" going-up":c>b.order?d+=" going-down":d="",b.rating!==b.oldRating){var e,f=b.rating-b.oldRating;0<f?(e="plus",f="+"+f):e="minus",b.$el.find(".chan-rating-delta").text("".concat(f)).removeClass("plus minus").addClass(e)}b.$el.addClass(d+(f?" delta-show":"")),setTimeout(function(){return b.$el.removeClass("hovering going-down going-up delta-show")},1e3)}b.order=c,b.oldRating=b.rating}),this.arranged=!0},arranged:!1,mockRandOrder:function mockRandOrder(a){a=a||.3,this.chans.forEach(function(b){Math.random()<a&&(b.rating=Math.round(1e3*Math.random()),b.$el.find(".chan-rating").text("".concat(b.rating)))}),this.arrange()}},API={getRates:function getRates(){this.request("rates")},getChallenge:function getChallenge(){this.request("challenge")},captcha:function captcha(a){this.request("captcha","POST",{captcha:a})},vote:function vote(a){"left"!==a&&"right"!==a&&this.handleError("You can only vote Left or Right"),this.request("vote","POST",{v:a})},request:function request(a,b,c){var d=this;$.ajax({url:"api.php?act=".concat(a),type:b||"GET",data:c||null}).done(function(a){return a.error?d.handleError(a.error):void d.handleData(a.data)}).fail(function(a){return d.handleError("XHR error: ",a)})},handleData:function handleData(a){a.hasOwnProperty("vote_success")&&$("body").removeClass("enter-captcha"),a.hasOwnProperty("rates")&&chanTop.updateRatings(a.rates),a.hasOwnProperty("challengers")&&Masher.setNewChallenge(a.challengers),a.hasOwnProperty("debug")&&console.log(a.debug)},handleError:function handleError(a){return this.specialErrors.hasOwnProperty(a)?this.specialErrors[a]():console.error(a),!1},specialErrors:{enter_captcha:function enter_captcha(){$("body").addClass("enter-captcha"),updateCaptcha()},wrong_captcha:function wrong_captcha(){$("#captcha-panel").addClass("wrong"),setTimeout(function(){return $("#captcha-panel").removeClass("wrong")},1e3),updateCaptcha()},force_reload:function force_reload(){return document.location.reload()}}};function updateCaptcha(){$("#cpanel-wrap img").attr("src","/captcha.php?color=200,200,200"),$("input[name=captcha]").val("").focus()}var Masher={init:function init(a,b){var c=this;this.$el=a;var d="";b.forEach(function(a){var b=$(c.buildChan(a));b.find("a, .chan-options").click(function(a){a.stopPropagation()}),b.find(".adder-remover").click(function(){installer.toggle(a.id)}),c.pool[a.id]=b,d+="\n#ch_".concat(a.id," {\n ").concat(c.gradient(a.catbg)," \n}")}),injector.inject("catalog-gradients",d),$(".challenger").click(function(){$(".catalog-chan").addClass("post"),API.vote($(this).attr("id").split("c-")[1])}),API.getChallenge()},pool:{},buildChan:function buildChan(a){var b=installer.isInstalled(a.id),c=b?"\xD7":"+",d=b?"\u0423\u0434\u0430\u043B\u0438\u0442\u044C":"\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C",e=_.escape(a.name),f=a.wiki&&a.wiki.match(/https?:\/\//)?a.wiki:conf.wiki+(a.wiki||e);return"<div class=\"catalog-chan\"><div class=\"cc-ball-wrap\" id=\"ch_".concat(a.id,"\"><img src=\"/chans/balls/").concat(a.section,"/").concat(a.id,".png").concat(a.ballv?"?v=".concat(a.ballv):"","\" alt=\"").concat(e,"\" class=\"cc-ball\"><a href=\"").concat(_.escape(a.url),"\" target=\"_blank\" class=\"channame-overlay\">").concat(e,"</a><div class=\"chan-options co-add adder-remover\" title=\"").concat(d,"\">").concat(c,"</div><a href=\"").concat(f,"\" target=\"_blank\" class=\"chan-options co-info\" title=\"\u0418\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u044F\">i</a></div></div>")},setNewChallenge:function setNewChallenge(a){var b=this,c=a.map(function(a){return a=b.pool[a.id].addClass("pre").removeClass("post")}),d=_slicedToArray(c,2),e=d[0],f=d[1];$("#c-left").append(e),$("#c-right").append(f),setTimeout(function(){$(".challenger .catalog-chan").removeClass("pre")},500)},gradient:function gradient(a){var b="linear-gradient(to bottom, #".concat(a[0]," 0%, #").concat(a[1]," 100%)"),c=/(((?:radial|linear)-gradient)\((?:(ellipse) at center|(-?[0-9]+)deg|to (right|bottom)), ?(.+)\));?/i.exec(b);if(null===c)return"background:"+b;c=_.rest(_.without(c,void 0));var d,e=c[0]+"; ",f=c[1];d=isNaN(c[2])?"bottom"==c[2]?"top, ":"right"==c[2]?"left, ":"center, ellipse cover, ":90-parseFloat(c[2])+"deg, ";var g=c[3];return _.each(["-o-","-webkit-","-moz-"],function(a){e+="background:"+a+f+"("+d+g+"); "}),"background:"+e}};function main(){$.ajaxSetup({dataType:"json"}),$.getJSON("/chans/chans.json?v=".concat(new Date().getTime())).done(function(a){a.chans&&a.version?initAll(a.chans,a.version):console.error("bad-json")}).fail(function(a){return console.error(a)}),has3d=has3d()}function initAll(a,b){a=a.filter(function(a){return!a.offline}),a.forEach(function(a){a.section=a["default"]?"default":"custom"}),installer.init(a,b),chanTop.init($("#chantop"),a),Masher.init($("#battleground"),a),$("header").click(function(){if(640>=$(window).width()){var a=$("body").hasClass("xpnd");$("body").toggleClass("xpnd"),a||$("#battleground-wrap").scrollTop(0)}}),$("#cpanel-wrap img").click(updateCaptcha),$("#captcha-panel").submit(function(a){a.preventDefault(),API.captcha($("input[name=captcha]").val())}),$(window).keydown(function(a){if(!$("body").hasClass("enter-captcha")){if("ArrowLeft"==a.key||"a"==a.key)API.vote("left");else if("ArrowRight"==a.key||"d"==a.key)API.vote("right");else return;$(".catalog-chan").addClass("post")}})}var installer={installed:[],init:function init(a,b){var c=this;this.list=a,this.versions=LSfetchJSON("catalogVersions")||{},this.versions.server=b;var d=LSfetchJSON("myChans_new");d&&d.length?d.forEach(function(b){var d=_.find(a,{id:b.id});c.installed.push(d||b)}):this.installed=_.filter(a,{included:!0}),this.sync(!0)},sync:function sync(a){localStorage.myChans_new=JSON.stringify(this.installed),a&&(localStorage.catalogVersions=JSON.stringify(this.versions))},isInstalled:function isInstalled(a){return!!_.find(this.installed,{id:a})},indicate:function indicate(a,b,c){[Masher.pool[a],_.find(chanTop.chans,{id:a}).$el].forEach(function(a){a.find(".adder-remover").text(b).attr("title",c)})},install:function install(a){var b=_.find(this.list,{id:a});b&&(this.installed.push(b),this.sync(),this.indicate(a,"\xD7","\u0423\u0434\u0430\u043B\u0438\u0442\u044C"))},uninstall:function uninstall(a){var b=_.remove(this.installed,{id:a});b&&(this.sync(),this.indicate(a,"+","\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C"))},toggle:function toggle(a){this.isInstalled(a)?this.uninstall(a):this.install(a)}},conf={wiki:"http://wiki.1chan.ca/"},injector={inject:function inject(a,b){var c="injector:".concat(a),d=document.getElementById(c);if(d)return void(d.innerHTML=b);var e=document.head||document.getElementsByTagName("head")[0],f=document.createElement("style");f.type="text/css",f.id=c,f.styleSheet?f.styleSheet.cssText=b:f.appendChild(document.createTextNode(b)),e.appendChild(f)},remove:function remove(a){var b="injector:".concat(a),c=document.getElementById(b);if(c){var d=document.head||document.getElementsByTagName("head")[0];d&&d.removeChild(document.getElementById(b))}}};function has3d(){if(!window.getComputedStyle)return!1;var a,b=document.createElement("p"),c={webkitTransform:"-webkit-transform",OTransform:"-o-transform",msTransform:"-ms-transform",MozTransform:"-moz-transform",transform:"transform"};for(var d in document.body.insertBefore(b,null),c)void 0!==b.style[d]&&(b.style[d]="translate3d(1px,1px,1px)",a=window.getComputedStyle(b).getPropertyValue(c[d]));return document.body.removeChild(b),void 0!==a&&0<a.length&&"none"!==a}function LSfetchJSON(a){var b=null,c=localStorage[a];if("undefined"!=typeof c)try{b=JSON.parse(c)}catch(b){console.error(b),localStorage.removeItem(a)}return b}
//# sourceMappingURL=chantop.js.map